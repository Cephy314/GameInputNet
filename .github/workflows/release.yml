name: 'Release'

on:
  release:
    types: [ published ]

permissions:
  contents: write
  packages: write

jobs:
  publish:
    name: Publish Package
    runs-on: ubuntu-latest
    env:
      NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.release.tag_name }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore GameInputNet.sln

      - name: Pack library
        env:
          PACKAGE_VERSION: ${{ github.event.release.tag_name }}
        run: |
          dotnet pack GameInput.Net/GameInput.Net.csproj \
            -c Release \
            /p:Version=${PACKAGE_VERSION} \
            /p:ContinuousIntegrationBuild=true \
            --no-restore

      - name: Locate package
        id: package_path
        env:
          VERSION: ${{ github.event.release.tag_name }}
        run: |
          PACKAGE_PATH="GameInput.Net/bin/Release/GameInput.Net.${VERSION}.nupkg"
          if [ ! -f "${PACKAGE_PATH}" ]; then
            echo "Expected package ${PACKAGE_PATH} was not found." >&2
            exit 1
          fi
          echo "package_path=${PACKAGE_PATH}" >> "${GITHUB_OUTPUT}"

      - name: Upload package to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ${{ steps.package_path.outputs.package_path }}
          asset_name: GameInput.Net.${{ github.event.release.tag_name }}.nupkg
          asset_content_type: application/octet-stream

      - name: Push to NuGet (optional)
        if: ${{ env.NUGET_API_KEY != '' }}
        env:
          VERSION: ${{ github.event.release.tag_name }}
          NUGET_API_KEY: ${{ env.NUGET_API_KEY }}
        run: |
          dotnet nuget push "GameInput.Net/bin/Release/GameInput.Net.${VERSION}.nupkg" \
            --api-key "${NUGET_API_KEY}" \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate
